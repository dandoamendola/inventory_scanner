<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pick Logger — Scan / Manual / Photo</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;display:flex;flex-direction:column;height:100vh}
  #top{background:#0d47a1;color:#fff;padding:10px}
  #controls{padding:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  #reader{flex:1;display:flex;align-items:center;justify-content:center;background:#000;color:#fff}
  #list{max-height:220px;overflow:auto;padding:8px;background:#f9f9f9}
  .row{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #eee;align-items:center}
  .small{font-size:0.85rem;color:#444}
  button{padding:8px 12px;margin:4px}
  input,select{padding:6px}
  .thumb{height:36px;margin-left:8px;border:1px solid #ccc}
  #debug{font-size:0.85rem;padding:6px;color:#333;background:#fafafa;border-top:1px solid #ddd}
</style>
</head>
<body>
  <div id="top"><strong>Pick Logger</strong> — Scan, Manual serial & Photo</div>

  <div id="controls">
    <label>Technician: <input id="tech" placeholder="Your name"></label>
    <label>Action:
      <select id="action"><option value="Taken">Taken</option><option value="Returned">Returned</option></select>
    </label>
    <label>Mode:
      <select id="mode"><option value="scan">Scan</option><option value="manual">Manual+Photo</option></select>
    </label>
    <button id="clearAll">Clear</button>
    <button id="shareBtn">Share summary</button>
  </div>

  <div id="reader">Camera preview will appear here (allow camera)</div>

  <div style="padding:8px">
    <div style="display:flex;gap:8px;align-items:center;">
      <div>
        <input id="manualCode" placeholder="Type serial here (manual mode)" style="width:220px">
      </div>
      <div>
        <input id="photoInput" accept="image/*" type="file" capture="environment" style="display:inline-block">
      </div>
      <div>
        <button id="addManual">Add manual</button>
        <button id="ocrBtn" title="OCR is optional and may be slow on phones">Try OCR (optional)</button>
      </div>
    </div>
  </div>

  <div id="list"></div>

  <div id="debug">
    <div><strong>Debug</strong></div>
    <div id="dbg-status">status: idle</div>
    <div id="dbg-cameras">cameras: unknown</div>
    <div id="dbg-msg"></div>
  </div>

<!-- libs -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<!-- Tesseract (commented out by default; enable only if needed, big lib)
<script src="https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
-->

<script>
/* ========== CONFIG ========== */
// If you want server logging / automatic save to Google Sheet, put your Apps Script Web App URL here:
const APPS_SCRIPT_URL = "YOUR_APPS_SCRIPT_URL"; // <-- replace with your URL or "" if unused
/* ============================ */

console.log("Pick Logger starting...");
const html5QrCode = new Html5Qrcode("reader");
const items = {}; // barcode/serial -> {qty, barcode, photos: [dataURLs]}
const listEl = document.getElementById('list');
const techEl = document.getElementById('tech');
const actionEl = document.getElementById('action');
const modeEl = document.getElementById('mode');
const manualInput = document.getElementById('manualCode');
const photoInput = document.getElementById('photoInput');
const ocrBtn = document.getElementById('ocrBtn');
const dbgStatus = document.getElementById('dbg-status');
const dbgCameras = document.getElementById('dbg-cameras');
const dbgMsg = document.getElementById('dbg-msg');

let cameraStarted = false;
let currentCameraId = null;

// helper debug
function dbg(s,m){
  dbgStatus.textContent = 'status: ' + s;
  dbgCameras.textContent = 'cameras: ' + (m || '');
  console.log('DBG:', s, m);
  if(m) dbgMsg.textContent = m;
}

function renderList(){
  listEl.innerHTML = '';
  Object.keys(items).forEach(k=>{
    const it = items[k];
    const r = document.createElement('div'); r.className='row';
    const left = document.createElement('div');
    left.innerHTML = `<div><strong>${k}</strong> <span class="small">(${it.type||'item'})</span></div><div class="small">${it.note||''}</div>`;
    const right = document.createElement('div');
    right.innerHTML = `<span>x${it.qty}</span>`;
    if(it.photos && it.photos.length){
      it.photos.forEach((p,idx)=>{
        const img = document.createElement('img'); img.src = p; img.className='thumb';
        img.title = `Photo ${idx+1}`;
        right.appendChild(img);
      });
    }
    const rem = document.createElement('button'); rem.textContent='−'; rem.style.marginLeft='8px';
    rem.addEventListener('click', ()=>{ delete items[k]; renderList(); });
    right.appendChild(rem);

    r.appendChild(left); r.appendChild(right);
    listEl.appendChild(r);
  });
}

function addItem(code, photoDataURL){
  code = String(code).trim();
  if(!code) return;
  if(!items[code]) items[code] = {qty:0, barcode:code, photos:[]};
  items[code].qty += 1;
  if(photoDataURL) items[code].photos.push(photoDataURL);
  renderList();
}

// try to auto-start best camera (prefers rear)
function startCameraAuto() {
  dbg('listing cameras','requesting camera list...');
  Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length){
      dbg('cameras found', cameras.length + ' camera(s)');
      // choose camera: try to pick one with 'back' or 'rear' in label or default to last
      let cam = cameras[0];
      for(const c of cameras){
        const lab = (c.label || '').toLowerCase();
        if(lab.indexOf('back')>=0 || lab.indexOf('rear')>=0 || lab.indexOf('environment')>=0) { cam = c; break; }
      }
      currentCameraId = cam.id;
      dbg('starting camera', cam.label || cam.id);
      const config = { fps: 8, qrbox: { width: Math.min(window.innerWidth, 320), height: Math.min(200, window.innerHeight/2) }, formatsToSupport: ["ean_13","ean_8","code_128","upc_a","upc_e","code_39","code_93"] };
      html5QrCode.start(currentCameraId, config,
        (decodedText, decodedResult) => {
          console.log('SCAN:', decodedText);
          addItem(decodedText);
        },
        (err) => {
          // scanning error during camera operation (ignore)
        }
      ).then(()=>{ cameraStarted = true; dbg('camera running', cam.label || currentCameraId); })
      .catch(err=>{
        dbg('start failed','Could not start scanner: ' + String(err));
      });
    } else {
      dbg('no cameras','Browser returned no cameras — try Chrome on Android or Safari on iOS');
    }
  }).catch(err=>{
    dbg('getCameras failed', String(err));
  });
}

function stopCamera() {
  if(cameraStarted) {
    html5QrCode.stop().then(()=> { cameraStarted = false; dbg('stopped','camera stopped'); document.getElementById('reader').innerText = 'Camera preview stopped'; }).catch(err=> dbg('stop error', String(err)));
  }
}

// start only if mode = scan
modeEl.addEventListener('change', ()=> {
  if(modeEl.value === 'scan') startCameraAuto(); else stopCamera();
});

// add manual with (optional) photo
document.getElementById('addManual').addEventListener('click', ()=>{
  const code = manualInput.value.trim();
  if(!code){ alert('Type serial or scan first'); return; }
  if(photoInput.files && photoInput.files[0]){
    const f = photoInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
      addItem(code, e.target.result);
      manualInput.value=''; photoInput.value='';
    };
    reader.readAsDataURL(f);
  } else {
    addItem(code,null);
    manualInput.value='';
  }
});

// share -> try to post to Apps Script if configured, else open WhatsApp
async function postToServer(payload) {
  if(!APPS_SCRIPT_URL) return { status: "no-server" };
  try {
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await resp.json();
    return result;
  } catch(e) {
    console.error("POST failed", e);
    return { status: "error", message: e.toString() };
  }
}

document.getElementById('shareBtn').addEventListener('click', async ()=>{
  if(Object.keys(items).length===0){ alert('No items scanned'); return; }
  const tech = techEl.value || 'Unknown';
  const action = actionEl.value || 'Taken';
  const now = new Date().toISOString();

  const itemsPayload = [];
  for(const k of Object.keys(items)){
    itemsPayload.push({
      code: k,
      qty: items[k].qty,
      photoDataUrl: (items[k].photos && items[k].photos.length) ? items[k].photos[0] : ""
    });
  }

  const payload = { technician: tech, action: action, timestamp: now, items: itemsPayload, note: "" };

  dbg('sending','posting payload to server (if configured)...');
  document.getElementById('shareBtn').textContent = "Sending...";
  const serverResult = await postToServer(payload);
  document.getElementById('shareBtn').textContent = "Share summary";

  if(serverResult && serverResult.status === "ok") {
    alert('Sent to sheet successfully');
    // clear list after successful send
    for(let k in items) delete items[k];
    renderList();
    dbg('sent','server accepted payload');
    return;
  } else if(serverResult && serverResult.status === "no-server") {
    dbg('no server','opening WhatsApp share as fallback');
    // Build human-readable text
    let text = `TECH: ${tech}\nACTION: ${action}\nTIME: ${new Date().toLocaleString()}\n\nItems:\n`;
    itemsPayload.forEach(it=> text += `${it.code}  x${it.qty}\n`);
    // Web Share API preferred
    if(navigator.share) {
      try {
        await navigator.share({ text: text });
        // optional: clear
        for(let k in items) delete items[k];
        renderList();
      } catch(e){ window.open('https://wa.me/?text=' + encodeURIComponent(text),'_blank'); }
    } else {
      window.open('https://wa.me/?text=' + encodeURIComponent(text),'_blank');
    }
    return;
  } else {
    alert('Failed to send to server (see console), opening WhatsApp fallback.');
    console.error('Server result:', serverResult);
    let text = `TECH: ${tech}\nACTION: ${action}\nTIME: ${new Date().toLocaleString()}\n\nItems:\n`;
    itemsPayload.forEach(it=> text += `${it.code}  x${it.qty}\n`);
    window.open('https://wa.me/?text=' + encodeURIComponent(text),'_blank');
    dbg('server error', serverResult && serverResult.message ? serverResult.message : JSON.stringify(serverResult));
  }
});

// clear
document.getElementById('clearAll').addEventListener('click', ()=>{ if(confirm('Clear scanned list?')) { for(let k in items) delete items[k]; renderList(); } });

// start camera by default if in scan mode
window.addEventListener('load', ()=> {
  console.log('Page loaded. UA:', navigator.userAgent);
  if(modeEl.value === 'scan') startCameraAuto();
});

</script>
</body>
</html>
