<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Barcode Reader — EAN optimized (pause-on-detect)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f3f5f7}
  header{background:#0d47a1;color:#fff;padding:12px}
  .wrap{max-width:980px;margin:18px auto;padding:12px;background:#fff;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  #controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  #reader{width:100%;height:360px;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;border-radius:4px;overflow:hidden;position:relative}
  select,input,button,textarea{padding:8px;border:1px solid #ccc;border-radius:4px}
  button{cursor:pointer;background:#0d47a1;color:#fff;border:none}
  button.secondary{background:#666}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6e9ed;padding:8px;text-align:left}
  .muted{color:#666;font-size:0.9rem}

  /* STATUS BADGE and FRAME OVERLAY adjustments for mobile/video stacking */
  .status-badge{position: fixed; top: 12px; right: 12px; background: rgba(0,0,0,0.7); color: #fff; padding: 6px 10px; border-radius: 12px; font-size: 13px; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.25);}
  #reader { position: relative; overflow: hidden; }

  /* frame guide */
  .frame-overlay{position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); border: 3px dashed rgba(255,255,255,0.92); border-radius: 6px; pointer-events: none; z-index: 9998; box-sizing: border-box; width: 86%; height: 18%; max-width: 900px; max-height: 220px;}
  .frame-overlay.small-mode{ height: 14%; }

  /* video layer styling so overlay can be above it on iOS */
  .video-layer{position: absolute !important; top: 0; left: 0; width: 100% !important; height: 100% !important; object-fit: cover !important; z-index: 9997 !important; -webkit-transform: translate3d(0,0,0); transform: translate3d(0,0,0);}
</style>
</head>
<body>
<header><div style="max-width:980px;margin:0 auto">Barcode Reader — EAN optimized (pause-on-detect)</div></header>
<div class="wrap">
  <div id="controls">
    <label>Mode:
      <select id="mode"><option value="scan">Scan</option><option value="manual">Manual</option></select>
    </label>

    <button id="listCams">List cameras</button>
    <select id="camSelect" style="min-width:220px"></select>
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="secondary">Stop</button>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="manualInput" placeholder="Inserisci codice (manual)" style="width:240px">
      <button id="addManual">Add</button>
    </div>
  </div>

  <div id="reader">
    Camera preview (consenti camera)
    <div class="frame-overlay" id="frameOverlay"></div>
  </div>

  <div id="listArea">
    <h3>Scanned items</h3>
    <table id="tbl"><thead><tr><th>Code</th><th>Qty</th><th>Last seen</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div id="statusBadge" class="status-badge">Ready</div>

<!-- Put a local copy of html5-qrcode here named html5-qrcode.min.js OR paste the lib inline -->
<script src="html5-qrcode.min.js"></script>

<script>
/* core app with EAN optimizations, frame-scan fallback and pause-on-detect */

// debug nodes fallback (hidden)
const dbgStatus = document.getElementById('dbg-status') || (function(){ const d = document.createElement('div'); d.id='dbg-status'; d.style.display='none'; document.body.appendChild(d); return d; })();
const dbgConsole = document.getElementById('dbg-console') || (function(){ const p = document.createElement('pre'); p.id='dbg-console'; p.style.display='none'; document.body.appendChild(p); return p; })();

const reader = document.getElementById('reader');
const camSelect = document.getElementById('camSelect');
const modeEl = document.getElementById('mode');
const tblBody = document.querySelector('#tbl tbody');
const manualInput = document.getElementById('manualInput');
const statusBadge = document.getElementById('statusBadge');

function log(s,m='') {
  try{
    if(statusBadge){
      let short = s + (m ? ' — ' + m : '');
      statusBadge.textContent = short.length > 36 ? short.substring(0,33) + '...' : short;
    }
  }catch(e){}
  try{ dbgStatus.textContent = 'status: ' + s + (m ? ' — ' + m : ''); dbgConsole.textContent = (new Date().toLocaleTimeString()) + ' | ' + s + (m ? ' — ' + m : '') + "\\n" + dbgConsole.textContent; }catch(e){}
  console.log(s,m);
}

// state
let rawStream = null, html5Q=null, detector=null, scanning=false, seen={}, bdStop=null;
let frameScanInterval = null, lastDecodeTs = 0, FRAME_SCAN_PERIOD = 1500, FRAME_MAX_WIDTH = 1600;
let pauseTimeoutId = null;
let lastChosenCamera = undefined;

// render table
function renderTable(){
  tblBody.innerHTML = '';
  Object.keys(seen).forEach(code=>{
    const r=seen[code];
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${r.qty}</td><td>${new Date(r.lastTs).toLocaleString()}</td>`;
    tblBody.appendChild(tr);
  });
}

// when code seen — update lastDecodeTs and pause camera briefly
function addSeen(code){
  code = String(code || '').trim();
  if(!code) return;
  if(!seen[code]) seen[code] = {qty:0, lastTs:0};
  seen[code].qty += 1;
  seen[code].lastTs = Date.now();
  lastDecodeTs = Date.now();
  renderTable();
  // pause camera briefly to avoid duplicates (1.5s)
  pauseCamera(1500);
}

// capture+scan single frame helper (uses html5-qrcode.scanFile if available)
async function captureAndScanFrame(videoEl){
  if(!videoEl || videoEl.readyState < 2) return null;
  try {
    const vw = videoEl.videoWidth || videoEl.clientWidth;
    const vh = videoEl.videoHeight || videoEl.clientHeight;
    if(!vw || !vh) return null;
    const scale = Math.min(1, FRAME_MAX_WIDTH / vw);
    const cw = Math.round(vw * scale);
    const ch = Math.round(vh * scale);
    const canvas = document.createElement('canvas');
    canvas.width = cw; canvas.height = ch;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, cw, ch);
    const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.9));
    if(!blob) return null;
    let scanResult = null;
    try {
      if(window.html5Q && typeof html5Q.scanFile === 'function'){
        scanResult = await html5Q.scanFile(blob, false);
      } else if(window.Html5Qrcode && typeof Html5Qrcode.scanFile === 'function'){
        scanResult = await Html5Qrcode.scanFile(blob, false);
      } else {
        return null;
      }
    } catch(eScan){
      console.warn('captureAndScanFrame - scanFile error', eScan && eScan.message ? eScan.message : eScan);
      return null;
    }
    let code = null;
    if(!scanResult) return null;
    if(typeof scanResult === 'string') code = scanResult;
    else if(Array.isArray(scanResult) && scanResult.length > 0) code = scanResult[0].decodedText || scanResult[0].rawValue || null;
    else if(scanResult.decodedText) code = scanResult.decodedText;
    else if(scanResult.rawValue) code = scanResult.rawValue;
    if(code){ addSeen(code); console.log('captureAndScanFrame -> decoded:', code); return code; }
    return null;
  } catch(e){ console.error('captureAndScanFrame exception', e); return null; }
}

// frame-scan loop
function startFrameScanLoop(){
  if(frameScanInterval) return;
  frameScanInterval = setInterval(async ()=>{
    try{
      if(!scanning) return;
      if(Date.now() - lastDecodeTs < 1200) return;
      const v = document.querySelector('#reader video');
      if(!v) return;
      await captureAndScanFrame(v);
    } catch(e){ console.error('frame-scan loop error', e); }
  }, FRAME_SCAN_PERIOD);
}
function stopFrameScanLoop(){ if(frameScanInterval){ clearInterval(frameScanInterval); frameScanInterval = null; } }

// BarcodeDetector native
async function tryBarcodeDetector(videoEl){
  if(!('BarcodeDetector' in window)){ log('BarcodeDetector not available'); return false; }
  try {
    const supported = await BarcodeDetector.getSupportedFormats();
    log('BarcodeDetector supported: ' + supported.join(','));
    detector = new BarcodeDetector({formats: supported});
    let stop=false;
    const loop = async ()=> {
      if(stop || videoEl.paused || videoEl.ended) return;
      try {
        const codes = await detector.detect(videoEl);
        if(codes && codes.length) codes.forEach(c=>addSeen(c.rawValue));
      }catch(e){}
      requestAnimationFrame(loop);
    };
    loop();
    return ()=>{ stop=true; };
  } catch(e){ log('BarcodeDetector error', e.message || e); return false; }
}

// robust startHtml5 with EAN-optimized cfg
async function startHtml5(cameraId){
  if(!window.Html5Qrcode){ log('Html5Qrcode not present','cannot start html5-qrcode'); return false; }
  try {
    if(!html5Q) html5Q = new Html5Qrcode('reader');
    const cfg = {
      fps: 18,
      qrbox: { width: Math.min(window.innerWidth, 900), height: Math.max(90, Math.min(window.innerHeight * 0.18, 220)) },
      formatsToSupport: ["code_128","code_39","code_93","ean_13","ean_8","upc_a","upc_e"]
    };
    // attempts: try cameraId string, deviceId exact, facingMode, default
    const attempts = [];
    if(cameraId){
      attempts.push(cameraId);
      attempts.push({ deviceId: { exact: cameraId } });
      attempts.push({ deviceId: cameraId });
    }
    attempts.push({ facingMode: "environment" });
    attempts.push(undefined);
    for(const arg of attempts){
      try {
        log('html5-qrcode attempt start','arg=' + (arg === undefined ? '(default)' : (typeof arg === 'string' ? arg : JSON.stringify(Object.keys(arg)))));
        if(arg === undefined){
          await html5Q.start({ facingMode: "environment" }, cfg, decoded => { addSeen(decoded); }, err=>{});
        } else {
          await html5Q.start(arg, cfg, decoded => { addSeen(decoded); }, err=>{});
        }
        log('html5-qrcode running (1-D optimized)','start succeeded');
        // start frame-scan loop to enhance EAN detection
        scanning = true;
        startFrameScanLoop();
        // ensure overlay placement
        try{ if(typeof placeOverlayAfterVideo === 'function') setTimeout(placeOverlayAfterVideo, 80); }catch(e){}
        return true;
      } catch(eStart){
        const em = (eStart && eStart.message) ? eStart.message : String(eStart);
        log('html5.start failed for arg', em);
        console.error('html5.start failed for arg', arg, eStart);
        try{ await html5Q.stop(); }catch(_){}
        try{ if(typeof html5Q.clear === 'function') html5Q.clear(); }catch(_){}
        await new Promise(r=>setTimeout(r,200));
      }
    }
    log('html5-qrcode could not start','all attempts failed');
    return false;
  } catch(e){ log('html5 unexpected error', e && e.message ? e.message : e); console.error('startHtml5 unexpected', e); return false; }
}

// raw preview fallback
async function startRaw(cameraId){
  try{
    const constraints = cameraId ? { video:{ deviceId:{ exact: cameraId } } } : { video:{ facingMode:'environment' } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    if(rawStream) try{ rawStream.getTracks().forEach(t=>t.stop()); }catch(e){}
    rawStream = stream;
    reader.innerHTML = '';
    const v = document.createElement('video');
    v.autoplay=true; v.playsInline=true; v.muted=true; v.srcObject = stream;
    v.classList.add('video-layer');
    v.style.maxWidth='100%';
    reader.appendChild(v);
    const labels = stream.getTracks().map(t=>t.label).join(', ');
    log('raw preview started','tracks: ' + labels);
    // start frame-scan loop when using raw
    scanning = true;
    startFrameScanLoop();
    return v;
  }catch(e){ log('raw preview failed', e.message || e); return null; }
}

// list cameras with auto-select
async function listCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    camSelect.innerHTML = '';
    vids.forEach((d,i)=>{ const opt=document.createElement('option'); opt.value=d.deviceId; opt.text = d.label || ('camera '+(i+1)); camSelect.appendChild(opt); });
    log('cameras listed: ' + vids.length);
    // auto select preferred rear camera (avoid ultra-wide if label suggests)
    try{
      if(camSelect.options.length > 0){
        let preferred = null;
        for(let i=0;i<camSelect.options.length;i++){
          const t = camSelect.options[i].text.toLowerCase();
          if(t.includes('posteriore') && !t.includes('ultra') && !t.includes('ultra-grandangolo') && !t.includes('anter')) { preferred = camSelect.options[i].value; break; }
        }
        if(!preferred){
          for(let i=0;i<camSelect.options.length;i++){ const t = camSelect.options[i].text.toLowerCase(); if(t.includes('posteriore')) { preferred = camSelect.options[i].value; break; } }
        }
        if(!preferred) preferred = camSelect.options[camSelect.options.length-1].value;
        camSelect.value = preferred;
        log('auto-selected camera id', camSelect.value);
      }
    }catch(e){ log('auto-select camera failed', e && e.message ? e.message : e); }
    return vids;
  }catch(e){ log('enumerate failed', e.message || e); return []; }
}

// pause scanning for ms milliseconds (stop streams and restart after)
async function pauseCamera(ms){
  try{
    if(pauseTimeoutId) clearTimeout(pauseTimeoutId);
    // stop html5 if active
    try{ if(html5Q){ await html5Q.stop(); html5Q = null; } }catch(e){}
    // stop barcode detector
    try{ if(bdStop){ bdStop(); bdStop=null; } }catch(e){}
    // stop raw stream
    try{ if(rawStream){ rawStream.getTracks().forEach(t=>t.stop()); rawStream=null; } }catch(e){}
    scanning = false;
    log('Paused','resuming in ' + ms + 'ms');
    pauseTimeoutId = setTimeout(async ()=>{ pauseTimeoutId = null; log('Resuming scan'); await startAll(false); }, ms);
  }catch(e){ console.error('pauseCamera error', e); }
}

// orchestrator: startAll accepts clearSeen flag
async function startAll(clearSeen=true){
  if(scanning) return;
  if(clearSeen){ seen={}; renderTable(); }
  await listCameras();
  const chosen = camSelect.value || undefined;
  lastChosenCamera = chosen;
  log('startAll','chosen camera: ' + (chosen || '(none)'));
  try{
    const html5ok = await startHtml5(chosen);
    if(html5ok){ log('scanning with html5-qrcode (direct)','OK'); return; }
    log('html5-qrcode direct start failed — falling back to raw preview','attempting fallback');
  }catch(e){ log('startAll html5 attempt threw', e && e.message ? e.message : e); console.error('startAll html5 attempt threw', e); }
  const vEl = await startRaw(chosen);
  if(!vEl){ scanning=false; log('startAll aborted','raw preview failed'); return; }
  try{
    const bd = await tryBarcodeDetector(vEl);
    if(bd){ bdStop = bd; log('scanning with BarcodeDetector (native)','OK'); return; }
  }catch(e){ log('BarcodeDetector attempt error', e && e.message ? e.message : e); console.error('BarcodeDetector attempt error', e); }
  try{
    if(rawStream){ rawStream.getTracks().forEach(t=>t.stop()); rawStream=null; reader.innerHTML='camera preview'; }
    const html5second = await startHtml5(chosen);
    if(html5second){ log('scanning with html5-qrcode (after raw stop)','OK'); return; }
  }catch(e){ log('second html5 attempt error', e && e.message ? e.message : e); console.error('second html5 attempt error', e); }
  log('startAll finished — no automatic decoder available','raw preview left running');
  return;
}

// stop all
async function stopAll(){
  scanning=false;
  try{ if(bdStop){ bdStop(); bdStop=null; } }catch(e){}
  try{ if(html5Q){ await html5Q.stop(); html5Q = null; } }catch(e){}
  if(rawStream){ try{ rawStream.getTracks().forEach(t=>t.stop()); }catch(e){} rawStream=null; }
  stopFrameScanLoop();
  reader.innerHTML='camera preview';
  log('stopped all');
}

// UI wiring
document.getElementById('listCams').addEventListener('click', ()=> listCameras());
document.getElementById('startBtn').addEventListener('click', ()=> startAll(true));
document.getElementById('stopBtn').addEventListener('click', ()=> stopAll());
document.getElementById('addManual').addEventListener('click', ()=> { const v=manualInput.value.trim(); if(v){ addSeen(v); manualInput.value=''; } });

// overlay placement helper (exposed for use)
function placeOverlayAfterVideo(){
  const reader = document.getElementById('reader');
  if(!reader) return;
  const fo = document.getElementById('frameOverlay') || (function(){ const e=document.createElement('div'); e.id='frameOverlay'; e.className='frame-overlay'; reader.appendChild(e); return e; })();
  const v = reader.querySelector('video');
  if(v){
    v.classList.add('video-layer');
    // move overlay to end
    reader.appendChild(fo);
  } else {
    if(fo.parentNode !== reader) reader.appendChild(fo);
  }
}

// ensure overlay is placed when video inserted
(function(){
  const readerNode = document.getElementById('reader');
  if(readerNode){
    placeOverlayAfterVideo();
    const mo = new MutationObserver((mutations)=>{
      for(const m of mutations){
        if(m.addedNodes && m.addedNodes.length){
          for(const n of m.addedNodes){
            if(n.tagName && n.tagName.toLowerCase() === 'video'){
              setTimeout(()=>placeOverlayAfterVideo(),80);
            }
          }
        }
      }
    });
    mo.observe(readerNode, { childList:true });
    window.addEventListener('resize', ()=> setTimeout(placeOverlayAfterVideo,80));
    window.addEventListener('orientationchange', ()=> setTimeout(placeOverlayAfterVideo,120));
  }
})();

// on load: list cameras
window.addEventListener('load', ()=> { log('page loaded — ready'); listCameras(); });
</script>

</body>
</html>
