<!-- /index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory — Scanner</title>
  <style>
    :root { --pad: 14px; --radius: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b0c10; color: #e6e6e6; }
    header { padding: var(--pad); display:flex; align-items:center; gap:10px; }
    header h1 { font-size: 18px; margin:0; font-weight: 600; }
    main { padding: var(--pad); }
    .card { background:#15171d; border:1px solid #23262d; border-radius: var(--radius); padding: var(--pad); }

    /* Narrow preview for iPhone 13 + overlay */
    .previewWrap { position: relative; width: 100%; height: 140px; border-radius: 12px; overflow: hidden; background:#000; }
    #preview { position:absolute; inset:0; width:100%; height:100%; object-fit: cover; }
    .overlay { position:absolute; inset:0; pointer-events:auto; display:flex; align-items:center; justify-content:center; }
    .overlay .guide { width: 82%; height: 34%; border: 2px solid rgba(255,255,255,.95); border-radius: 10px; box-shadow: 0 0 0 2000px rgba(0,0,0,.45); outline: 1px solid rgba(0,0,0,.35); }

    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .btn { appearance:none; border:1px solid #2c3038; background:#1f232b; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background:#4b7bec; border-color:#4b7bec; }
    .btn.ghost { background:transparent; }
    .muted { opacity: .75; }
    .list { margin-top: 10px; }
    .item { display:grid; grid-template-columns: 1fr auto auto auto; gap:10px; align-items:center; padding:10px; border-bottom:1px solid #23262d; }
    .qtyBox { display:flex; gap:6px; align-items:center; }
    .qty { min-width: 44px; text-align:center; padding:8px; border-radius:10px; border:1px solid #2c3038; background:#101218; color:#fff; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid #2c3038; border-radius:999px; text-align:center; }
    .status { margin-top:8px; font-size:13px; min-height: 1.4em; }
    .danger { color: #ff6b6b; }
    .ok { color: #1dd1a1; }
    .grid { display:grid; gap:10px; }
    .kpi { display:flex; justify-content:space-between; font-size:13px; opacity:.85; }
    .hint { font-size: 12px; opacity:.8; }
    .hidden { display:none; }
    .hr { height:1px; background:#23262d; margin:10px 0; }
  </style>
</head>
<body>
  <header>
    <h1>Inventory — Scanner</h1>
  </header>

  <main class="grid">
    <section class="card">
      <div class="grid">
        <label class="muted">Device / User</label>
        <input id="user" class="qty" style="text-align:left; min-width:unset;" placeholder="e.g. Marco" />
        <div class="hint">Manual rule: length=8 → CODE_128, else → EAN.</div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <label class="muted">Camera</label>
        <select id="camera" class="qty" style="text-align:left; min-width:unset;"></select>

        <div class="previewWrap" id="wrap">
          <video id="preview" playsinline muted autoplay></video>
          <div class="overlay" id="overlay" title="Tap to force scan">
            <div class="guide"></div>
          </div>
        </div>

        <div class="row">
          <button id="start" class="btn primary">Start</button>
          <button id="stop" class="btn">Stop</button>
          <button id="torch" class="btn ghost">Torch</button>
          <button id="force" class="btn">Scan now</button>
        </div>
        <div class="status" id="status"></div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <label class="muted">Manual entry</label>
        <div class="row">
          <input id="manualCode" class="qty" placeholder="Barcode" />
          <input id="manualQty" class="qty" type="number" step="0.5" min="0.5" value="1" />
          <button id="addManual" class="btn">Add</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="kpi">
        <div>Items: <b id="kCount">0</b></div>
        <div>Total qty: <b id="kQty">0</b></div>
      </div>
      <div class="list" id="list"></div>
      <div class="row" style="margin-top:10px;">
        <button id="clear" class="btn">Clear</button>
        <button id="export" class="btn">Export CSV</button>
        <button id="sendSheet" class="btn primary">Send to Google Sheet</button>
      </div>
      <div class="status" id="note"></div>
    </section>

    <section id="exportPanel" class="card hidden">
      <h3>CSV ready</h3>
      <div class="hint">A=Code128, E=EAN, I=Qty (0.5). Open in Excel.</div>
      <textarea id="csv" style="width:100%; height:160px; margin-top:8px; border-radius:10px; background:#101218; color:#eee; border:1px solid #2c3038; padding:10px;"></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="copy" class="btn">Copy CSV</button>
        <button id="share" class="btn">Share</button>
        <button id="download" class="btn">Download .csv</button>
      </div>
    </section>
  </main>

  <!-- ZXing UMDs: library first, then browser -->
  <script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/zxing-browser.min.js"></script>
  <script>
    // ==== CONFIG ====
    const https://script.google.com/macros/s/AKfycbxk50fg0IH69dTGCdAyOxap2x5XLSPBHdtcc_TVYK4/dev = 'PASTE_WEB_APP_URL_HERE'; // Apps Script Web App URL

    // ==== State & Utils ====
    const STORAGE_KEY = 'inv_cart_v1';
    const $ = (sel) => document.querySelector(sel);

    function normalizeQty(v) {
      let n = Number(v);
      if (!Number.isFinite(n)) n = 1;
      n = Math.max(0.5, n);
      n = Math.round(n * 2) / 2; // 0.5 steps
      const frac = Math.abs(n - Math.trunc(n));
      if (frac !== 0 && Math.abs(frac - 0.5) > 1e-9) n = Math.trunc(n) + 0.5;
      return n;
    }

    function loadCart() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; } }
    function saveCart() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.cart)); }
    function totalItems() { return Object.keys(state.cart).length; }
    function totalQty() { return Object.values(state.cart).reduce((s, it) => s + Number(it.qty || 0), 0); }

    const state = {
      cart: loadCart(), // { [barcode]: { barcode, qty, lastType } }
      scanning: false,
      controls: { codeReader: null, selectedDeviceId: null, torchOn: false },
      lastDecode: { text: '', t: 0 },
      hints: null,
    };

    function renderList() {
      const list = $('#list'); list.innerHTML = '';
      for (const it of Object.values(state.cart)) {
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div>
            <div><b>${it.barcode}</b></div>
            <div class="muted" style="font-size:12px;">${it.lastType || ''}</div>
          </div>
          <div class="qtyBox">
            <button class="btn" data-act="dec">–</button>
            <input class="qty" data-role="qty" type="number" step="0.5" min="0.5" value="${it.qty}" />
            <button class="btn" data-act="inc">+</button>
          </div>
          <div class="pill">x</div>
          <button class="btn danger" data-act="del">Remove</button>
        `;
        row.querySelector('[data-act="inc"]').onclick = () => { it.qty = normalizeQty(Number(it.qty) + 1); changed(); };
        row.querySelector('[data-act="dec"]').onclick = () => { it.qty = normalizeQty(Math.max(0.5, Number(it.qty) - 1)); changed(); };
        row.querySelector('[data-role="qty"]').onchange = (e) => { it.qty = normalizeQty(e.target.value); e.target.value = it.qty; changed(); };
        row.querySelector('[data-act="del"]').onclick = () => { delete state.cart[it.barcode]; changed(); };
        list.appendChild(row);
      }
      $('#kCount').textContent = String(totalItems());
      $('#kQty').textContent = String(totalQty());
    }
    function changed() { saveCart(); renderList(); }

    function addScan(barcode, type) {
      if (!barcode) return;
      const key = barcode;
      if (!state.cart[key]) state.cart[key] = { barcode, qty: 1, lastType: type || '' };
      else state.cart[key].qty = normalizeQty(Number(state.cart[key].qty) + 1);
      navigator.vibrate?.(20);
      changed();
    }

    // ==== Scanner ====
    const { BrowserMultiFormatReader } = ZXingBrowser;
    const { BarcodeFormat, DecodeHintType } = ZXing;

    function fmtName(fmt) {
      for (const [k, v] of Object.entries(BarcodeFormat)) if (v === fmt) return k;
      return String(fmt);
    }
    const benignErrNames = new Set(['NotFoundException', 'ChecksumException', 'FormatException']);
    const isBenignZXingError = (err) => {
      if (!err) return false;
      if (benignErrNames.has(err.name)) return true;
      return /No MultiFormat Readers were able|checksum|format/i.test(String(err?.message || err));
    };

    async function listCameras() {
      const tmp = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      tmp.getTracks().forEach(t => t.stop());
      const devices = await navigator.mediaDevices.enumerateDevices();
      return devices.filter(d => d.kind === 'videoinput');
    }
    const pickRear = (cams) => (cams.find(c => /back|rear|environment/i.test(c.label || ''))?.deviceId ?? cams.at(-1)?.deviceId ?? cams[0]?.deviceId ?? null);

    async function populateCameras() {
      const sel = $('#camera'); sel.innerHTML = '';
      const cams = await listCameras();
      cams.forEach((c, i) => {
        const opt = document.createElement('option');
        opt.value = c.deviceId; opt.textContent = c.label || `Camera ${i + 1}`;
        sel.appendChild(opt);
      });
      const prefer = pickRear(cams);
      if (prefer) sel.value = prefer;
      state.controls.selectedDeviceId = sel.value || null;
    }

    function buildHints() {
      const hints = new Map();
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.CODE_128, BarcodeFormat.EAN_13, BarcodeFormat.EAN_8]);
      hints.set(DecodeHintType.TRY_HARDER, true);
      state.hints = hints;
      return hints;
    }

    async function startScanner() {
      if (!navigator.mediaDevices?.getUserMedia) { $('#status').innerHTML = '<span class="danger">Camera API not supported.</span>'; return; }
      try {
        $('#status').textContent = 'Starting…';
        await populateCameras();
        const codeReader = new BrowserMultiFormatReader(buildHints(), 250);
        state.controls.codeReader = codeReader;
        state.scanning = true;

        const video = $('#preview');
        const deviceId = state.controls.selectedDeviceId || $('#camera').value || null;

        const onDecode = (result, err) => {
          if (result) {
            const text = result.getText().trim();
            const now = Date.now();
            if (text !== state.lastDecode.text || (now - state.lastDecode.t) > 1200) {
              const typeName = fmtName(result.getBarcodeFormat?.());
              addScan(text, typeName);
              state.lastDecode = { text, t: now };
              $('#status').textContent = `Read: ${text} (${typeName})`;
            }
          } else if (err && !isBenignZXingError(err)) {
            $('#status').innerHTML = `<span class="danger">Scanner error: ${String(err.message || err)}</span>`;
          } else {
            $('#status').textContent = 'Scanning…';
          }
        };

        try {
          if (deviceId) {
            await codeReader.decodeFromVideoDevice(deviceId, video, onDecode);
            $('#status').textContent = 'Scanner running (device)';
            return;
          }
          throw new Error('No deviceId');
        } catch {
          try {
            await codeReader.decodeFromConstraints({
              video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } },
              audio: false
            }, video, onDecode);
            $('#status').textContent = 'Scanner running (constraints)';
            return;
          } catch {
            await codeReader.decodeFromVideoDevice(null, video, onDecode);
            $('#status').textContent = 'Scanner running (auto device)';
            return;
          }
        }
      } catch (e) {
        $('#status').innerHTML = `<span class="danger">${e?.message || e}</span>`;
        if (/NotAllowedError/i.test(String(e))) $('#status').innerHTML += '<br><span class="hint">Allow camera permission.</span>';
      }
    }

    async function stopScanner() {
      try {
        state.scanning = false;
        state.controls.codeReader?.reset();
        const vid = $('#preview');
        const tracks = vid.srcObject?.getTracks?.() || [];
        tracks.forEach(t => t.stop());
        vid.srcObject = null;
        $('#status').textContent = 'Scanner stopped';
      } catch {}
    }

    async function toggleTorch() {
      try {
        const video = $('#preview');
        const track = video.srcObject?.getVideoTracks?.()[0];
        if (!track) { $('#status').textContent = 'No active camera'; return; }
        const cap = track.getCapabilities?.();
        if (!cap || !cap.torch) { $('#status').textContent = 'Torch not supported'; return; }
        state.controls.torchOn = !state.controls.torchOn;
        await track.applyConstraints({ advanced: [{ torch: state.controls.torchOn }] });
        $('#status').textContent = state.controls.torchOn ? 'Torch ON' : 'Torch OFF';
      } catch { $('#status').textContent = 'Unable to toggle torch'; }
    }

    // ==== Force scan (ROI) ====
    function getRoiFromOverlay() {
      const video = $('#preview'), wrap = $('#wrap'), guide = $('#overlay .guide');
      const vw = video.videoWidth, vh = video.videoHeight;
      if (!vw || !vh) return null;
      const bw = wrap.clientWidth, bh = wrap.clientHeight;
      const scale = Math.max(bw / vw, bh / vh); // cover
      const xOff = (bw - vw * scale) / 2, yOff = (bh - vh * scale) / 2;
      const gr = guide.getBoundingClientRect(), wr = wrap.getBoundingClientRect();
      const left = gr.left - wr.left, top = gr.top - wr.top;
      let sx = (left - xOff) / scale, sy = (top - yOff) / scale;
      let sw = gr.width / scale, sh = gr.height / scale;
      sx = Math.max(0, Math.min(vw, sx)); sy = Math.max(0, Math.min(vh, sy));
      sw = Math.max(1, Math.min(vw - sx, sw)); sh = Math.max(1, Math.min(vh - sy, sh));
      return { sx, sy, sw, sh };
    }

    function forceScanNow() {
      const roi = getRoiFromOverlay();
      if (!roi) { $('#status').textContent = 'Camera not ready…'; return; }
      const video = $('#preview');
      const { sx, sy, sw, sh } = roi;

      const canvas = document.createElement('canvas');
      const scaleUp = Math.min(3, Math.max(1, 900 / Math.max(sw, sh))); // helps 1D decode
      canvas.width = Math.round(sw * scaleUp);
      canvas.height = Math.round(sh * scaleUp);
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

      try {
        const reader = new BrowserMultiFormatReader(state.hints || buildHints());
        const result = reader.decodeFromCanvas(canvas); // sync; throws if no code
        reader.reset();
        const text = result.getText().trim();
        const typeName = fmtName(result.getBarcodeFormat?.());
        addScan(text, typeName);
        $('#status').textContent = `Read: ${text} (${typeName})`;
      } catch (err) {
        $('#status').textContent = 'No code in rectangle';
      }
    }

    // ==== CSV/Sheet rows (A/E/I) ====
    function buildRow9(it) {
      const qty = normalizeQty(it.qty);
      const q = (qty % 1) ? qty.toFixed(1) : String(qty);
      const t = String(it.lastType || '').toUpperCase();
      const row = ['', '', '', '', '', '', '', '', '']; // A..I
      if (t === 'CODE_128') row[0] = String(it.barcode);       // A
      if (t === 'EAN_13' || t === 'EAN_8' || t === 'EAN') row[4] = String(it.barcode); // E
      row[8] = q; // I
      return row;
    }

    function buildCSV() {
      const rows = Object.values(state.cart)
        .filter(it => ['CODE_128','EAN_13','EAN_8','EAN'].includes(String(it.lastType).toUpperCase()))
        .map(it => buildRow9(it).map((v,i)=> (i===0||i===4) ? `"${String(v).replace(/"/g,'""')}"` : String(v)).join(','));
      return rows.join('\r\n');
    }

    function showCSV() {
      const rows = buildCSV();
      $('#csv').value = rows;
      $('#exportPanel').classList.remove('hidden');
      if (!rows) $('#note').innerHTML = '<span class="hint">Nothing to export yet.</span>';
    }

    async function doCopyCSV() {
      try { await navigator.clipboard.writeText($('#csv').value); $('#note').innerHTML = '<span class="ok">CSV copied</span>'; }
      catch { $('#note').innerHTML = '<span class="danger">Clipboard not available</span>'; }
    }

    async function doShareCSV() {
      try {
        const bom = '\uFEFF', data = bom + $('#csv').value;
        const file = new File([data], 'inventory.csv', { type: 'text/csv;charset=utf-8' });
        if (navigator.canShare?.({ files: [file] })) await navigator.share({ files: [file], title: 'Inventory CSV' });
        else if (navigator.share) await navigator.share({ title: 'Inventory CSV', text: data });
        else $('#note').textContent = 'Native share not supported';
      } catch {}
    }

    function downloadCSV() {
      const bom = '\uFEFF';
      const blob = new Blob([bom + $('#csv').value], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'inventory.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ==== Google Sheets submit ====
    function buildSheetRows() {
      return Object.values(state.cart)
        .filter(it => ['CODE_128','EAN_13','EAN_8','EAN'].includes(String(it.lastType).toUpperCase()))
        .map(buildRow9);
    }

    async function sendToGoogleSheet() {
      if (!https://script.google.com/macros/s/AKfycbxk50fg0IH69dTGCdAyOxap2x5XLSPBHdtcc_TVYK4/dev || https://script.google.com/macros/s/AKfycbxk50fg0IH69dTGCdAyOxap2x5XLSPBHdtcc_TVYK4/dev.startsWith('PASTE_')) { $('#note').innerHTML = '<span class="danger">Set https://script.google.com/macros/s/AKfycbxk50fg0IH69dTGCdAyOxap2x5XLSPBHdtcc_TVYK4/dev (Apps Script Web App URL).</span>'; return; }
      const rows = buildSheetRows();
      if (!rows.length) { $('#note').innerHTML = '<span class="hint">No rows to send.</span>'; return; }
      const btn = $('#sendSheet'); btn.disabled = true; btn.textContent = 'Sending…';
      try {
        const r = await fetch(https://script.google.com/macros/s/AKfycbxk50fg0IH69dTGCdAyOxap2x5XLSPBHdtcc_TVYK4/dev, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rows }) });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        $('#note').innerHTML = '<span class="ok">Sent to Google Sheet</span>';
      } catch {
        try { await fetch(https://script.google.com/macros/s/AKfycbxk50fg0IH69dTGCdAyOxap2x5XLSPBHdtcc_TVYK4/dev, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ rows }) }); $('#note').innerHTML = '<span class="ok">Sent (no-cors)</span>'; }
        catch { $('#note').innerHTML = '<span class="danger">Send failed</span>'; }
      } finally { btn.disabled = false; btn.textContent = 'Send to Google Sheet'; }
    }

    // ==== Clear / Manual ====
    function clearAll() {
      if (!confirm('Clear the list?')) return;
      state.cart = {}; changed();
      $('#exportPanel').classList.add('hidden');
    }

    // Manual: 8 chars → CODE_128; else → EAN (per your rule)
    function addManual() {
      const code = $('#manualCode').value.trim();
      const qty = normalizeQty($('#manualQty').value || 1);
      if (!code) return;
      const type = (code.length === 8) ? 'CODE_128' : 'EAN';
      if (!state.cart[code]) state.cart[code] = { barcode: code, qty, lastType: type };
      else state.cart[code].qty = normalizeQty(Number(state.cart[code].qty) + qty);
      $('#manualCode').value = '';
      changed();
    }

    // ==== Wiring ====
    $('#camera').addEventListener('change', (e) => { state.controls.selectedDeviceId = e.target.value; if (state.scanning) { stopScanner(); startScanner(); } });
    $('#start').onclick = startScanner;
    $('#stop').onclick = stopScanner;
    $('#torch').onclick = toggleTorch;
    $('#force').onclick = forceScanNow;
    $('#overlay').onclick = forceScanNow;
    $('#export').onclick = showCSV;
    $('#copy').onclick = doCopyCSV;
    $('#share').onclick = doShareCSV;
    $('#download').onclick = downloadCSV;
    $('#sendSheet').onclick = sendToGoogleSheet;
    $('#clear').onclick = clearAll;
    $('#addManual').onclick = addManual;

    // init
    (async () => {
      renderList();
      try { await populateCameras(); } catch {}
      $('#note').innerHTML = '<span class="hint">A=CODE128, E=EAN, I=Qty (manual: len=8→CODE128).</span>';
    })();
  </script>
</body>
</html>
