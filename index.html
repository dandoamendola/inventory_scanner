<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Barcode Reader — Web App</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f3f5f7}
  header{background:#0d47a1;color:#fff;padding:12px}
  .wrap{max-width:980px;margin:18px auto;padding:12px;background:#fff;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  #controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  #reader{width:100%;height:360px;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;border-radius:4px;overflow:hidden}
  select,input,button,textarea{padding:8px;border:1px solid #ccc;border-radius:4px}
  button{cursor:pointer;background:#0d47a1;color:#fff;border:none}
  button.secondary{background:#666}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6e9ed;padding:8px;text-align:left}
  #debug{margin-top:10px;padding:8px;background:#fafafa;border-radius:4px;border:1px solid #eee;font-size:0.9rem}
  .muted{color:#666;font-size:0.9rem}
  #embedBox{display:none;margin-top:8px}
  .thumb{height:28px;border:1px solid #ddd;margin-left:6px}
</style>
</head>
<body>
<header><div style="max-width:980px;margin:0 auto">Barcode Reader — Web App (1-D barcodes)</div></header>
<div class="wrap">
  <div id="controls">
    <label>Mode:
      <select id="mode"><option value="scan">Scan</option><option value="manual">Manual</option></select>
    </label>

    <button id="checkLib">Check/Embed library</button>
    <button id="listCams">List cameras</button>
    <select id="camSelect" style="min-width:220px"></select>
    <button id="startBtn">Start</button>
    <button id="stopBtn" class="secondary">Stop</button>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="manualInput" placeholder="Inserisci codice (manual)" style="width:240px">
      <button id="addManual">Add</button>
    </div>
  </div>

  <div id="embedBox">
    <div class="muted">Se non vuoi scaricare il file esterno, incolla qui il contenuto minificato di <code>html5-qrcode.min.js</code> e premi <strong>Embed</strong>. Questo renderà la pagina completamente autonoma.</div>
    <textarea id="embedArea" style="width:100%;height:160px;margin-top:6px" placeholder="Incolla qui il contenuto di html5-qrcode.min.js"></textarea>
    <div style="margin-top:6px"><button id="embedBtn">Embed</button> <button id="cancelEmbed">Cancel</button></div>
  </div>

  <div id="reader">Camera preview (consenti camera)</div>

  <div id="listArea">
    <h3>Scanned items</h3>
    <table id="tbl"><thead><tr><th>Code</th><th>Qty</th><th>Last seen</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="debug">
    <div id="dbg-status">status: idle</div>
    <pre id="dbg-console" style="max-height:160px;overflow:auto"></pre>
  </div>
</div>

<script>
/* ---------- simple barcode web app (1-D optimized) ---------- */
const dbgStatus = document.getElementById('dbg-status');
const dbgConsole = document.getElementById('dbg-console');
const reader = document.getElementById('reader');
const camSelect = document.getElementById('camSelect');
const modeEl = document.getElementById('mode');
const tblBody = document.querySelector('#tbl tbody');
const manualInput = document.getElementById('manualInput');
const embedBox = document.getElementById('embedBox');
const embedArea = document.getElementById('embedArea');

function log(s,m='') {
  dbgStatus.textContent = 'status: ' + s + (m ? ' — ' + m : '');
  dbgConsole.textContent = (new Date().toLocaleTimeString()) + ' | ' + s + (m ? ' — ' + m : '') + "\n" + dbgConsole.textContent;
  console.log(s,m);
}

let rawStream = null, html5Q=null, detector=null, scanning=false, seen={}, bdStop=null;

/* render */
function renderTable(){
  tblBody.innerHTML = '';
  Object.keys(seen).forEach(code=>{
    const r=seen[code];
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${code}</td><td>${r.qty}</td><td>${new Date(r.lastTs).toLocaleString()}</td>`;
    tblBody.appendChild(tr);
  });
}
function addSeen(code){
  code = String(code || '').trim();
  if(!code) return;
  if(!seen[code]) seen[code] = {qty:0, lastTs:0};
  seen[code].qty += 1;
  seen[code].lastTs = Date.now();
  renderTable();
}

/* BarcodeDetector native */
async function tryBarcodeDetector(videoEl){
  if(!('BarcodeDetector' in window)){ log('BarcodeDetector not available'); return false; }
  try {
    const supported = await BarcodeDetector.getSupportedFormats();
    log('BarcodeDetector supported: ' + supported.join(', '));
    detector = new BarcodeDetector({formats: supported});
    let stop=false;
    const loop = async ()=> {
      if(stop || videoEl.paused || videoEl.ended) return;
      try {
        const codes = await detector.detect(videoEl);
        if(codes && codes.length) codes.forEach(c=>addSeen(c.rawValue));
      }catch(e){}
      requestAnimationFrame(loop);
    };
    loop();
    return ()=>{ stop=true; };
  } catch(e){ log('BarcodeDetector error', e.message || e); return false; }
}

/* embed library if user pastes it */
function embedLibrary(text){
  try{
    const blob = new Blob([text], {type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    const s = document.createElement('script');
    s.src = url;
    s.onload = ()=>{ log('library embedded','Html5Qrcode available'); embedBox.style.display='none'; URL.revokeObjectURL(url); };
    s.onerror = ()=>{ log('embed failed','script load error'); };
    document.head.appendChild(s);
  }catch(e){ log('embed exception', e.message || e); }
}

/* html5 start (1-D optimized) */
async function ensureHtml5(){
  if(window.Html5Qrcode) return true;
  // request user to embed or to download external file
  embedBox.style.display = 'block';
  log('html5-qrcode missing','incolla il file o scaricalo dal repo e poi Embed');
  return false;
}

async function startHtml5(cameraId){
  if(!await ensureHtml5()) return false;
  if(!window.Html5Qrcode){ log('Html5Qrcode not present'); return false; }
  try{
    if(!html5Q) html5Q = new Html5Qrcode('reader');
    const cfg = {
      fps: 10,
      qrbox: { width: Math.min(window.innerWidth, 800), height: Math.min(window.innerHeight * 0.7, 600) },
      formatsToSupport: ["code_128","code_39","code_93","ean_13","ean_8","upc_a","upc_e"]
    };
    const arg = cameraId ? cameraId : { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} };
    await html5Q.start(arg, cfg, decoded => addSeen(decoded), err=>{} );
    log('html5-qrcode running (1-D optimized)');
    return true;
  }catch(e){ log('html5 start failed', e.message || e); return false; }
}

/* raw preview fallback */
async function startRaw(cameraId){
  try{
    const constraints = cameraId ? { video:{ deviceId:{ exact: cameraId }, width:{ideal:1280}, height:{ideal:720} } } : { video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    if(rawStream) try{ rawStream.getTracks().forEach(t=>t.stop()); }catch(e){}
    rawStream = stream;
    reader.innerHTML = '';
    const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.muted=true; v.srcObject = stream; v.style.maxWidth='100%';
    reader.appendChild(v);
    const labels = stream.getTracks().map(t=>t.label).join(', ');
    log('raw preview started','tracks: ' + labels);
    return v;
  }catch(e){ log('raw preview failed', e.message || e); return null; }
}

/* enumerate */
async function listCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    camSelect.innerHTML = '';
    vids.forEach((d,i)=>{ const opt=document.createElement('option'); opt.value=d.deviceId; opt.text = d.label || ('camera '+(i+1)); camSelect.appendChild(opt); });
    log('cameras listed: ' + vids.length);
    return vids;
  }catch(e){ log('enumerate failed', e.message || e); return []; }
}

/* orchestrator */
async function startAll(){
  if(scanning) return;
  scanning = true; seen={}; renderTable();
  await listCameras();
  const chosen = camSelect.value || undefined;
  const vEl = await startRaw(chosen);
  if(!vEl){ scanning=false; return; }
  const bd = await tryBarcodeDetector(vEl);
  if(bd){ bdStop = bd; log('scanning with BarcodeDetector'); return; }
  // stop raw and start html5
  if(rawStream){ rawStream.getTracks().forEach(t=>t.stop()); rawStream=null; reader.innerHTML='camera preview'; }
  const h = await startHtml5(chosen);
  if(h){ log('scanning with html5-qrcode'); return; }
  log('fallback: raw preview running but no automatic decoder available');
}

async function stopAll(){
  scanning=false;
  try{ if(bdStop){ bdStop(); bdStop=null; } }catch(e){}
  try{ if(html5Q){ await html5Q.stop(); html5Q = null; } }catch(e){}
  if(rawStream){ try{ rawStream.getTracks().forEach(t=>t.stop()); }catch(e){} rawStream=null; }
  reader.innerHTML='camera preview';
  log('stopped all');
}

/* UI wiring */
document.getElementById('checkLib').addEventListener('click', ()=> { if(window.Html5Qrcode){ log('Html5Qrcode present','ready'); } else { embedBox.style.display='block'; log('Paste html5-qrcode.min.js or download it then paste'); } });
document.getElementById('embedBtn')?.addEventListener('click', ()=> { const txt = embedArea.value.trim(); if(!txt){ alert('Incolla prima la libreria'); return; } embedLibrary(txt); });
document.getElementById('cancelEmbed')?.addEventListener('click', ()=> { embedBox.style.display='none'; });
document.getElementById('listCams').addEventListener('click', ()=> listCameras());
document.getElementById('startBtn').addEventListener('click', ()=> startAll());
document.getElementById('stopBtn').addEventListener('click', ()=> stopAll());
document.getElementById('addManual').addEventListener('click', ()=> { const v=manualInput.value.trim(); if(v){ addSeen(v); manualInput.value=''; } });

window.addEventListener('load', ()=> { log('page loaded — ready'); listCameras(); });
</script>
</body>
</html>
